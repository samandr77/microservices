# üí≥ Payment Service

–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤.

## –û–ø–∏—Å–∞–Ω–∏–µ

Payment Service –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –°–ë–ü), –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –±–∞–Ω–∫–∞–º–∏ –∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ —É—á–µ—Ç–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞–º–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É callback'–æ–≤ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –í–¢–ë –±–∞–Ω–∫–æ–º** - –ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –í–¢–ë
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°** - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —Å —Å–∏—Å—Ç–µ–º–æ–π —É—á–µ—Ç–∞
- **–°–ë–ü –ø–ª–∞—Ç–µ–∂–∏** - –°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- **–ö–∞—Ä—Ç–æ—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏** - –û–ø–ª–∞—Ç–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∫–∞—Ä—Ç–∞–º–∏
- **Invoice management** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
- **Callback –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –±–∞–Ω–∫–æ–≤
- **Background jobs** - –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **PostgreSQL + Kafka** - –ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Go** 1.23
- **PostgreSQL** - –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **Kafka** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è
- **HTTP/REST API** - –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **OpenAPI** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
payment/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ cmd/              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ internal/         # –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/          # HTTP handlers –∏ —Ä–æ—É—Ç–∏–Ω–≥
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gen/      # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π OpenAPI –∫–æ–¥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clients/      # HTTP –∫–ª–∏–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _1c/      # –ö–ª–∏–µ–Ω—Ç 1–°
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/     # –ö–ª–∏–µ–Ω—Ç Auth
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client/   # –ö–ª–∏–µ–Ω—Ç Client service
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vtbbank/  # –ö–ª–∏–µ–Ω—Ç –í–¢–ë
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity/       # –ë–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repository/   # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service/      # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ migrations/       # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ pkg/             # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞–∫–µ—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ job/          # Background jobs
‚îÇ       ‚îú‚îÄ‚îÄ security/     # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è
‚îÇ       ‚îî‚îÄ‚îÄ transport/    # HTTP —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
‚îî‚îÄ‚îÄ docker/              # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

## –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
cp example.env .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª
```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (PostgreSQL, Kafka):
```bash
cd docker
docker-compose up -d
```

3. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
cd app
make migrate-up
```

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å:
```bash
make run
```

### Docker

```bash
cd docker
docker-compose up
```

## API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É:
```
http://localhost:8084/swagger/index.html
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```env
# Server
SERVER_PORT=8084
LOG_LEVEL=debug

# PostgreSQL
POSTGRES_DSN=postgresql://user:password@localhost:5432/payment_db
POSTGRES_MAX_CONNS=10

# Kafka
KAFKA_BROKERS=localhost:9092
KAFKA_CONSUMER_ID=payment-service
KAFKA_PAYMENT_TOPIC=payments

# VTB Bank
VTB_API_URL=https://api.vtb.ru
VTB_MERCHANT_ID=your_merchant_id
VTB_API_KEY=your_api_key
VTB_PUBLIC_KEY_PATH=certs/vtb_public.pem
VTB_PRIVATE_KEY_PATH=certs/vtb_private.pem

# 1C
ONEC_API_URL=http://1c-api:8080
ONEC_USERNAME=admin
ONEC_PASSWORD=password

# Services
AUTH_SERVICE_URL=http://localhost:8080
CLIENT_SERVICE_URL=http://localhost:8081

# Background Jobs
JOB_CHECK_PAYMENTS_INTERVAL=1m
JOB_SYNC_1C_INTERVAL=5m
```

## –¢–∏–ø—ã –ø–ª–∞—Ç–µ–∂–µ–π

### –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã
–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –±–∞–Ω–∫–æ–≤—Å–∫—É—é –∫–∞—Ä—Ç—É —Å 3D-Secure:
```bash
POST /payments/card
{
  "amount": 1000.00,
  "currency": "RUB",
  "client_id": "uuid",
  "description": "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞"
}
```

### –°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –ë—ã—Å—Ç—Ä—ã—Ö –ü–ª–∞—Ç–µ–∂–µ–π)
–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ QR-–∫–æ–¥ –°–ë–ü:
```bash
POST /payments/spb
{
  "amount": 1000.00,
  "client_id": "uuid"
}
```

### –ò–Ω–≤–æ–π—Å—ã
–í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É:
```bash
POST /payments/invoices
{
  "amount": 5000.00,
  "client_id": "uuid",
  "description": "–°—á–µ—Ç ‚Ññ123"
}
```

## Callback –æ–±—Ä–∞–±–æ—Ç–∫–∞

–°–µ—Ä–≤–∏—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç callback'–∏ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º:

- `/payments/callbacks/card` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–∞—Ä—Ç–æ—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
- `/payments/callbacks/sbp` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –°–ë–ü –ø–ª–∞—Ç–µ–∂–∞—Ö

## Background Jobs

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –±–∞–Ω–∫–µ.

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å 1–°
–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Å–∏—Å—Ç–µ–º—É —É—á–µ—Ç–∞.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **TLS** - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–Ω–∫–∞–º–∏
- **Signature verification** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π callback'–æ–≤
- **Public key encryption** - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã** - –í–∑–∞–∏–º–Ω–∞—è TLS –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
make test
```

### –õ–∏–Ω—Ç–∏–Ω–≥

```bash
make lint
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è OpenAPI –∫–æ–¥–∞

```bash
make generate
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- [github.com/samandr77/microservices/auth](../auth) - –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- [github.com/samandr77/microservices/client](../client) - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ —Ç–∏–ø–∞–º
- –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback'–æ–≤

## –°—Å—ã–ª–∫–∏

- [–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π](https://github.com/samandr77/microservices)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ](docs/00-enviroments.md)
- [–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞](docs/01-dev-run.md)
- [Production](docs/02-production-run.md)
